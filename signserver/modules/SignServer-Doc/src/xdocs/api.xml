<?xml version="1.0" encoding="ISO-8859-1"?>

<!-- $Id$ -->

<document>
	<properties>
		<title>SignServer APIs</title>
	</properties>

	<body>

		<section name="JavaDoc">
			<p>
				The JavaDoc for SignServer is available at SIGNSERVER_HOME/tmp/doc/index.html
				after running "ant javadoc".
			</p>

		</section>
		
		<section name="Web Services">
			<p>
				See section 14.1 in the <a href="manual.html">manual</a> for information about this API.
			</p>
		</section>
		
		<section name="Java Client API">
			<p>
				See section 14.2 in the <a href="manual.html">manual</a> for information about this API.
			</p>
		</section>

		<section name="SigningAndValidation API">
			<p>
				The SigningAndValidation API is a wrapper around the previous 
				mentioned API in order to have a simplified interface that also 
				is the same regardless if WebService or EJB Remote calls are used. 
			</p>
			<p>
				To use the API include the file signingandvalidationapi.jar 
				as well as all JAR-files in the lib-folder available in 
				SIGNSERVER_HOME/dist-client/signingandvalidationapi/.
			</p>
			<subsection name="Sample Code">
				<subsubsection name="Signing and validating an XML document">
				<p>
					<pre>
try {
    ISigningAndValidation signserver = new SigningAndValidationWS("localhost", 8080);

    // Document to sign
    byte[] unsigned = "<document><name>Some content</name></document>".getBytes();
    byte[] signed;

    // Signing
    GenericSignResponse signResp = signserver.sign("XMLSigner", unsigned);
    signed = signResp.getProcessedData();
    System.out.println("Signed: " + new String(signed));

    // Validating
    GenericValidationResponse validateResp = signserver.validate("DemoXMLValidator", signed);
    System.out.println("Valid: " + validateResp.isValid());

    if(validateResp.getSignerCertificate() != null) {
        if(validateResp.getSignerCertificate() instanceof X509Certificate) {
            X509Certificate signerCert = (X509Certificate) validateResp.getSignerCertificate();
            System.out.println("Signed by: " + signerCert.getSubjectDN().getName());
        }
    }
} catch (Exception ex) {
    ex.printStackTrace();
}
        			</pre>
				</p>
				</subsubsection>
				
				<subsubsection name="MRTD Signing">
				<p>
					<pre>
try {
    ISigningAndValidation signserver = new SigningAndValidationWS("localhost", 8080);

    // Bytes to sign
    ArrayList&lt;byte[]&gt; bytesToSign = new ArrayList&lt;byte[]&gt;();
    bytesToSign.add("Sample data 1".getBytes());
    bytesToSign.add("Sample data 2".getBytes());

    // Signing
    MRTDSignResponse signResp = (MRTDSignResponse) signserver.process("MRTDSigner", new MRTDSignRequest(1234, bytesToSign), new RequestContext());

    System.out.println("Certificate: " + signResp.getSignerCertificate());

    if(signResp.getProcessedData() instanceof Collection) {
        Collection&lt;byte[]&gt; signed = (Collection) signResp.getProcessedData();
        for(byte[] data : signed) {
            System.out.println("Signed: " + new String(Base64.encode(data)));
        }
    }
} catch (Exception ex) {
    ex.printStackTrace();
}
        			</pre>
				</p>
				</subsubsection>				
				
			
			</subsection>
		</section>

                <section name="Web Server Interface">
                    <subsection name="GenericProcessServlet">
                        <p>
				HTTP requests can be sent to the SignServer servlet GenericProcessServlet located at /signserver/process using
                                either POST or GET.
			</p>
                        <p>
                            <table border="1">
                                <tr>
                                    <td>URL:</td><td><b>/signserver/process</b></td>
                                </tr>
                                <tr>
                                    <td>Method:</td><td><b>GET</b> or <b>POST</b></td>
                                </tr>
                                <tr>
                                    <td>Request content-type:</td><td><b>None</b>, <b>"x-www-form-urlencoded"</b>, <b>"multipart/form-data"</b> or <b>other<sup>*</sup></b></td>
                                </tr>
                                <tr>
                                    <td>Request parameters:</td>
                                    <td>
                                        <ul>
                                            <li><b>workerName</b> - Name of the worker that should handle the request. Required unless workerId specified.</li>
                                            <li><b>workerId</b> - Id of the worker that should handle the request. Required unless workerName specified.</li>
                                            <li><b>data</b> - The bytes that should be signed or validated. Required.</li>
                                            <li><b>encoding</b> - Encoding of the data field. Optional. By specifying "base64" SignServer Base64-decodes
                                            the data property before passing it to the worker.</li>
                                        </ul>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Response code:</td><td><b>200</b> (OK) or other in case of failure (i.e. 500 internal server error)</td>
                                </tr>
                                <tr>
                                    <td>Response content-type:</td><td>Depending on the worker</td>
                                </tr>
                            </table>
                            <sup>*</sup> if the request content-type in a POST is specified as something else than "x-www-form-urlencoded" or
                            "multipart/form-data" the message body is not parsed but instead directly passed to the worker specified by workerName or workerId
                            in the URI's query string.
                        </p>

                        <subsubsection name="Samples">
                            <p>
                            <ul>
                                <li>
                                    HTTP GET:<br/>
                                    http://localhost:8080/signserver/process?workerName=XMLSigner&amp;data=%3Croot%3Ehej2%3C/root%3E<br/>
                                    http://localhost:8080/signserver/process?workerName=XMLSigner&amp;encoding=base64&amp;data=PGhlajI%2Bb2s8L2hlajI%2BCg%3D%3D<br/>
                                    <br/>
                                </li>
                                <li>
                                    HTTP POST with multipart/form-data or x-www-form-urlencoded:<br/>
                                    For example see /signserver/xmlsign.html (multipart/form-data) and /signserver/genericsign.html (x-www-form-urlencoded).<br/>
                                    <br/>
                                </li>
                                <li>
                                    HTTP POST with other content-type:<br/>
                                    See the TimeStampClient.<br/>
                                    <br/>
                                </li>
                            </ul>
                        </p>
                        </subsubsection>
                        
                    </subsection>
                    <subsection name="WorkerServlet">
                    	<p>
							HTTP requests can be sent to the SignServer servlet WorkerServlet located at /signserver/worker/* using
                                either POST or GET.<br/>
                            Requests are forwarded to the GenericProcessServlet, except that the worker name is taken from the URL.<br/>
                            Worker name or ID given through request parameters are ignored.
						</p>
						<p>
                            <table border="1">
                                <tr>
                                    <td>URL:</td><td><b>/signserver/worker/* (* denotes a worker name)</b></td>
                                </tr>
                                <tr>
                                    <td>Method:</td><td><b>GET</b> or <b>POST</b></td>
                                </tr>
                                <tr>
                                    <td>Request content-type:</td><td><b>None</b>, <b>"x-www-form-urlencoded"</b>, <b>"multipart/form-data"</b> or <b>other<sup>*</sup></b></td>
                                </tr>
                                <tr>
                                    <td>Request parameters:</td>
                                    <td>
                                        <ul>
                                            <li><b>data</b> - The bytes that should be signed or validated. Required.</li>
                                            <li><b>encoding</b> - Encoding of the data field. Optional. By specifying "base64" SignServer Base64-decodes
                                            the data property before passing it to the worker.</li>
                                        </ul>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Response code:</td><td><b>200</b> (OK) or other in case of failure (i.e. 500 internal server error)</td>
                                </tr>
                                <tr>
                                    <td>Response content-type:</td><td>Depending on the worker</td>
                                </tr>
                            </table>
                    	</p>
                    	<subsubsection name="Samples">
                    	<p>
                            <ul>
                                <li>
                                    HTTP GET:<br/>
                                    http://localhost:8080/signserver/worker/XMLSigner?data=%3Croot%3Ehej2%3C/root%3E<br/><br/>
                                    Send signing request to the worker named XMLSigner.<br/><br/>
                                </li>
                            </ul>
                        </p>
                    	</subsubsection>
                    </subsection>
                    <subsection name="SODProcessServlet">
                        <p>
                            Servlet recieving HTTP POST requests containing data group hashes
                            and creates a MRTDSODSignerRequest and passes it to the specified
                            MRTDSODSigner. The response from the servlet is the signed security
                            object in binary format.
                        </p>
                        <p>
                            <table border="1">
                                <tr>
                                    <td>URL:</td><td><b>/signserver/sod</b></td>
                                </tr>
                                <tr>
                                    <td>Method:</td><td> <b>POST</b></td>
                                </tr>
                                <tr>
                                    <td>Request parameters:</td>
                                    <td>
                                        <ul>
                                            <li><b>workerName</b> - Name of the worker that should handle the request. Required unless workerId specified.</li>
                                            <li><b>workerId</b> - Id of the worker that should handle the request. Required unless workerName specified.</li>
                                            <li><b>dataGroup1 to dataGroup16</b> - The data group hashes that should be put in the SO(d). At least one required.</li>
                                            <li><b>encoding</b> - Encoding of the data group hash fields. Optional. By specifying "base64" SignServer Base64-decodes
                                            the data property before passing it to the MRTDSODSigner.</li>
                                        </ul>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Response code:</td><td><b>200</b> (OK) or other in case of failure (i.e. 500 internal server error)</td>
                                </tr>
                                <tr>
                                    <td>Response content-type:</td><td><b>application/octet-stream</b></td>
                                </tr>
                            </table>
                        </p>

                        <subsubsection name="Samples">
                            <p>
                            <ul>
                                <li>
                                    See /signserver/mrtdsodsign.html.<br/>
                                    <br/>
                                </li>
                            </ul>
                        </p>
                        </subsubsection>
                    </subsection>
		</section>

	</body>
</document>
