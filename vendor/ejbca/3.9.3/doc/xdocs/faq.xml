<?xml version="1.0"?>
<document>

  <properties>
    <title>FAQ</title>
  </properties>
  <faqsection title="General">
    <faq id="heapSpaceError">
     <question>
      I get an error with "Java heap space" when building EJBCA (during ant bootstrap).
      </question>
      <answer>
      <p>
      The error should be something like:<br/>
      /usr/local/ejbca_3_6_b1/compile.xmli:239: Java heap space
      </p>
      <p>
      This error is because the default maximum allowed memory allocation for java is too low.
      <br/>Do this in unixes:
      </p>
      <source>
      export ANT_OPTS=-Xmx=512m
      ant bootstrap
      </source>
      <p>On windows set the environment variable ANT_OPTS to -Xmx=512m, and restart your shell.
      </p>
      <p>That should work.
      </p>
      </answer>    
    </faq>
    
    <faq id="heapSpaceError">
     <question>
      My installation failed for some reason that is now fixed, how do I proceed?
      </question>
      <answer>
      <p>
      The best way to recover is usually o start over from scratch:
      </p>
      <ul>
      <li>Stop JBoss</li>
      <li>Make sure the database is clean</li>
      <li>Run "ant clean"</li>
      <li>Run "ant bootstrap"</li>
      <li>Start JBoss and check that it starts without problems</li>
      <li>Run "ant install"</li>
      <li>Stop JBoss and check that it stops without problems</li>
      <li>Run "ant deploy"</li>
      <li>Start JBoss and check that it starts without problems</li>
      <li>Remove the old superadmin.p12 in you browser and import the newly generated one</li>
      </ul>
      </answer>    
    </faq>
    
    <faq id="strangeErrors">
      <question>
      I get strange errors during 'ant bootstrap' or 'ant install'.
      </question>
      <answer>
      <p>
      This is most usually due to a database configuration error. In the server log (JBOSS_HOME/server/default/log/server.log)
      you will probably see some SQLException errors. You should then:
      </p>
      <ul>
      <li>Make sure the settings in conf/database.properties are correct</li>
      <li>Follow the guidelines from "My installation failed for some reason that is now fixed, how do I proceed?"</li>
      </ul>
      <p>
      See the configuration and troubleshooting section in doc/howto/HOWTO-database.txt for additional database related information.
      </p>
      </answer>
    </faq>
    
    <faq id="errorsDuringBuild">
      <question>During the build process I get errors like:
      BUILD FAILED
      /usr/ejbca/build.xml:789: java.lang.ExceptionInInitializerError
      </question>
      <answer>
      <p>
      You probably have ant pre-installed as a package from Fedora or Suse. Those pre-installations does not contain all default ant 
      modules. You need the "optional tasks" included in the official ant distribution. 
      Either add modules to the installed ant, or download the latest ant from http://ant.apache.org/.
      </p>
      <p>
      A simple fix is to change the /etc/ant.conf to point to your user installed ant (in /your/ant/home). Change from:
      </p>
      <pre>
#
# ant.conf (Ant 1.6.x)
# JPackage Project (http://www.jpackage.org/)
#

# Validate --noconfig setting in case being invoked
# from pre Ant 1.6.x environment
if [ -z "$no_config" ] ; then
  no_config=true
fi

# Setup ant configuration
if $no_config ; then
  # Disable RPM layout
  rpm_mode=false
else
  # Use RPM layout
  rpm_mode=true

  # ANT_HOME for rpm layout
  ANT_HOME=/usr/share/ant
fi
      </pre>
      <p>
      to this
      </p>
      <pre>
#
# ant.conf (Ant 1.6.x)
# JPackage Project (http://www.jpackage.org/)
#

# Validate --noconfig setting in case being invoked
# from pre Ant 1.6.x environment
if [ -z "$no_config" ] ; then
  no_config=true
fi

# Setup ant configuration
if $no_config ; then
  # Disable RPM layout
  rpm_mode=false
else
  # Use RPM layout
  rpm_mode=false

  # ANT_HOME for rpm layout
  ANT_HOME=/your/ant/home
fi      
      </pre>
      <p>
      For Ubuntu things are much easier, just 'sudo apt-get install ant' and 'sudo apt-get install ant-optional'.
      </p>
      </answer>
    </faq>

    <faq id="SHA256inIE">
     <question>
      SHA256 certs fails integrity check in IE
      </question>
      <answer>
      <p>
      Internet Explorer (at least IE6) does not support SHA256. 
      </p>
      <p>
      You can have an AdminCA using SHA1 and CAs for other purposes using SHA256.
      </p>
      </answer>
    </faq>

    <faq id="jbossServiceWin">
      <question>How can I run JBoss as a service in Windows?</question>
      <answer>
	      <p>There is documentation over at JBoss for several different options:
	      <br></br>
	      <a href="http://wiki.jboss.org/wiki/Wiki.jsp?page=RunJBossAsAServiceOnWindows">http://wiki.jboss.org/wiki/Wiki.jsp?page=RunJBossAsAServiceOnWindows</a>
	      </p>
	      <p>In short summary there are a couple of tools: <br></br>
	      <a href="http://javaservice.objectweb.org/">JavaService</a>
	      <br></br>       
	      <a href="http://wrapper.tanukisoftware.org/doc/english/integrate-simple-win.html">Java Service Wrapper</a>
	      </p>
      </answer>
    </faq>
    <faq id="PKCS10DNIgnored">
      <question>Enroll manually for a server - why are my PKCS10  DN fields Ignored?</question>
      <answer>
        <p>
		EJBCA does not trust the DN parts the user enters when he creates the
		PKCS10 request.
		The only way to match the certificate with what you enter in the
		pkcs10 is to enter the same thing in the end entity in ejbca.
		</p><p>
		PKCS#10 is the standard format for sending the public key (self signed
		to provide proof-of-possession) to a CA.
        </p>
      </answer>
    </faq>
    <faq id="logFileLocation">
      <question>Where is the log file stored for tracking errors and debug information?</question>
      <answer>
        <p>
        JBOSS_HOME/server/default/log/server.log.
        </p>
      </answer>
    </faq>
    <faq id="logLevelJBoss">
      <question>How do I configure log level in JBoss?</question>
      <answer>
        <p>
        JBOSS_HOME/server/default/conf/lo4j.xml. It is a good idea to limit the log level to not include debug logs. You can do this by changing the root category towards the end of log4j.xml:
        </p>
<source>
&lt;root&gt;
  &lt;priority value="ERROR" /&gt;
  &lt;appender-ref ref="CONSOLE"/&gt;
  &lt;appender-ref ref="FILE"/&gt;
&lt;/root> 
</source>
<p>
You may also choose to remove the CONSOLE logging completely.
</p>
<p>
You can also add this to limit the EJBCA logging to INFO, this will enable the logging system to avoid formatting
debug messages that will not be printed, enhancing performance some.
</p>
<source>
&lt;category name="org.ejbca"&gt;
   &lt;priority value="INFO"/&gt;
&lt;/category&gt;
</source>
<p>
You can here enable DEBUG logging for EJBCA by changing INFO to DEBUG. By doing all of the above (and playing around a little) 
you can get nice logging with only the things you are interested in logged to the log file.
</p>
      </answer>
    </faq>
    
    <faq id="addingStaticPages">
      <question>I want to add my own static pages under http://hostname:8080/ejbca/ ?</question>
      <answer>
        <p>
        Put your files (static html is easy) under publicweb/publicweb, do a full build and re-deploy.
        </p>
      </answer>
    </faq>
    
    <faq id="errorEstablish">
      <question>I get an error message when accessing the admin-GUI, "Could not establish an encrypted connection because your certificate was rejected ... Error code: -12224"?</question>
      <answer>
        <p>
        <b>1)</b> Make sure you have imported to correct superadmin.p12 in your browser.
        </p><p>
        <b>2)</b> You may have to delete and import the ca certificate in your java trust-store:
        </p>
<source>
sudo ant javatruststore
</source>
<p>
You can also import another CA than the initial AdminCA (My CA in the example) with the command:
</p>
<source>
sudo ant -Dca.name="My CA" javatruststore
</source>
<p>
Or you can run the commands manually. You don't have to do this if you use the convenience command 'ant javatruststore'.
</p>
<source>
bin/ejbca.sh ca getrootcert caname rootca.der -der
</source>
<source>
keytool -alias EJBCA-CA -delete -trustcacerts -keystore $JAVA_HOME/jre/lib/security/cacerts -storepass changeit
</source>
<source>
keytool -alias EJBCA-CA -import -trustcacerts -file rootca.der -keystore $JAVA_HOME/jre/lib/security/cacerts -storepass changeit
</source>
	<p>
	Make sure you restart JBoss after making changes to the java trust store.
	</p>
	<p>
	<b>3)</b> Perhaps the JBoss/Tomcat configuration was not done automatically because you are running another configuration than 'default'
	in JBoss. the file '$JBOSS_HOME/server/default/deploy/jbossweb-tomcat55.sar/server.xml' holds the Tomcat configuration.
	The configuration should be like the following, where 'serverpwd' is the 'httpsserver.password' as configured in ejbca.properties.
	</p>
<source>
&lt;!-- HTTPS Connector requiring client cert on port 8443 --&gt;
&lt;Connector port="8443" address="${jboss.bind.address}"
    maxThreads="100" strategy="ms" maxHttpHeaderSize="8192"
    emptySessionPath="true"
    scheme="https" secure="true" clientAuth="true"
    keystoreFile="${jboss.server.home.dir}/conf/keystore/keystore.jks"
    keystorePass="serverpwd" sslProtocol = "TLS" /&gt;
</source>
	<p>
	Also the file '$EJBCA_HOME/p12/tomcat.jks' must be copied to '$JBOSS_HOME/server/default/conf/keystore/keystore.jks', where 'default' should
	be replaced with the JBoss configuration you are using.
	</p>
      </answer>
    </faq>
    <faq id="blankPage">
      <question>I get a blank page on the admiweb after start?</question>
      <answer>
        <p>
		Either you entered a hostname (in httpsserver.hostname in ejbca.properties) that does not resolve to the 
		machine where EJBCA is running during setup, or you changed the port that JBoss listens to.
		Make sure the hostname resolves to the machine ejbca is running on.
		If you need the change to url, use the command 'bin/ejbca.sh setup setbaseurl'.
        </p>
      </answer>
    </faq>
    
    <faq id="jceLimitation">
      <question>When running 'ant install' or creating JKS or PKCS12 files you can't use longer 
password than 7 characters. Anything longer gives an error?</question>
      <answer>
        <p>
		If you want to use strong crypto and/or password longer than 7 characters 
		in keystores you must install the 'Unlimited Strength Jurisdiction Policy Files' for JDK.
		The policy files can be found at the same place as the JDK download. 
		Further information on this can be found in the Sun documentation on the JCE.
        </p>
        <p>
        Java 1.6.0<br/>
        Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy Files 6.0
        <br/><a href="http://java.sun.com/javase/downloads/index.jsp">http://java.sun.com/javase/downloads/index.jsp</a>
        </p>
        <p>
        Java 1.5.0<br/>
        Java Cryptography Extension (JCE) Unlimited Strength Jurisdiction Policy Files 5.0
        <br/><a href="http://java.sun.com/j2se/1.5.0/download.jsp">http://java.sun.com/j2se/1.5.0/download.jsp</a>
        </p>
      </answer>
    </faq>
    <faq>
      <question>Installation hangs and the https server will not work.</question>
      <answer>
        <p>
		Perhaps JBOSS_HOME/server/default/conf/keystore/tomcat.jks must be executable. All scripts in 
EJBCA_HOME/bin directory must be executable, run 'chmod u+x *.sh'. Make sure you run the 
installation of ejbca as a user with enough privileges to write in JBOSS_HOME, and to 
JAVA_HOME/jre/lib/security/cacerts. Preferably the same user as is used to run the JBoss server.
        </p>
      </answer>
    </faq>
    <faq id="alterHypersonic">
      <question>How do I connect to, and alter data in the built-in 'Hypersonic SQL' database.</question>
      <answer>
        <p>
A : Shut down JBoss.
Alternative 1:
If you want to simply drop a table, go into the file JBOSS_HOME\server\default\db\hypersonic\default.script and delete the lines that creates the table, for instance to delete the table GLOBALCONFIGURATIONDATA, delete the lines :
</p><source>
CREATE TABLE GLOBALCONFIGURATIONDATA(CONFIGURATIONID VARCHAR NOT NULL,DATA VARBINARY,UNIQUE(CONFIGURATIONID))
CREATE UNIQUE INDEX PK_GLOBALCONFIGURATIONDATA ON GLOBALCONFIGURATIONDATA(CONFIGURATIONID)
</source>
<p>
Just for fun you can also delete all lines beginning with: INSERT GLOBALCONFIGURATIONDATA...
</p><p>
Alternative 2:
Download HsqlDb fom http://hsqldb.sourceforge.net/. Unpack and in the 'bin'-subdirectory run 'runUtil DatabaseManager'.
In the window that opens connect to 'HSQL Engine Database In-Memory', select URL 'jdbc:hsqldb:$jboss.home\server\default\db\hypersonic\default'
where the path-to-jboss is for example 'C:\jboss\jboss-3.0.6_tomcat-4.1.18'.
Now you can enter you SQL-commands, for example 'drop table globalconfigurationdata'
and press 'Execute'. Unforturnately you must now go into the file
JBOSS_HOME\server\default\db\hypersonic\default.properties and set the version to the correct old one, edit
 the lines with 'version' to read 1.6 (for JBoss 3.0) instead of whatever is there.
 </p>
 </answer>
 </faq>
    <faq id="errorClsid">
      <question>When enrolling for certificates with IE, the enrollment controll (clsid) is incorrect.</question>
	  <answer><p>Microsoft changed the enrollment controll due to secrity issues. Look in 'src/publicweb/publicweb/anrol/apply/apply_exp.jspf' for more information.</p></answer>
	</faq>
    <faq id="errorOCV">
      <question>I get the error "Object Class Violation : (65)" when publishing certificates in LDAP</question>
	  <answer><p>You LDAP object class may require some fields in the DN that you have not entered. Some schemas require the DN-attribute SN for instance.</p></answer>
	</faq>
    <faq id="errorUserStatus">
      <question>Why do I get the exception/error: Got request with status GENERATED (40), NEW, FAILED or INPROCESS required: foo; nested exception is: javax.ejb.EJBException:null</question>
	  <answer><p>When using the LocalAuthenticationSession (default) all users have a STATUS. The status lifecycle
	  begins with NEW and ends with REVOKED. Only when the status is NEW, FAILED or INPROCESS is it possible
	  to issue a certificate to a user. After a certificate has been issued, the status is set to GENERATED. This works like a
	one-time-password scheme. To issue a new certificate to the user his/her status must be reset to NEW, FAILED or INPROCESS.
	This can be done with the admin-GUI or:
	<source>
	bin/ejbca.sh ra setuserstatus username status
	</source>
	Status '10' is NEW. Just enter 'bin/ejbca.sh ra setuserstatus' to see a list of all status codes.
	</p>
	</answer>
	</faq>
    <faq id="manipulateKeystore">
      <question>How do I manipulate EJBCA-keystores using Suns 'keytool'?</question>
	  <answer><p>EJBCA use PKCS12 format for the keystore because it is a standard, and I like standards.
	  Normally keytool (e.g. sun) can read PKCS12 file but not write, so the BouncyCastle JCE is needed to handle PKCS12 keystores.
	  Put the BouncyCastle provider 'bcprov-jkd15.jar' in 'jre/lib/ext', the default classpath for extensions in java.
	  Now it should be possible to run:
	  </p>
	  <source>
keytool -list -alias privateKey -keystore server.p12 -storetype PKCS12 -storepass foo123 -provider org.bouncycastle.jce.provider.BouncyCastleProvider
	  </source>
	  <p>
	  It should be possible to import etc as well using keytool.
	  </p></answer>
	</faq>
    <faq id="createKeystore">
      <question>How do I make a keystore using keytool with a real certificate from EJBCA?</question>
	  <answer>
<source>
# First generate a new keystore and a keypair:
keytool -genkey -alias mykey -keystore myks.jks -keyalg RSA -dname c=SE,O=AnaTom,CN=Test -keypass foo123 -storepass foo123
# You SUN keystore is now in the file 'myks.jks'. 
# Next generate a certification request (PKCS10):
keytool -certreq -alias mykey -sigalg SHA1WithRSA -file myreq.p10 -keypass foo123 -keystore myks.jks -storepass foo123
</source>
<p>
You now have the certification request in the file 'myreq.p10'.

Open up EJBCA request page in your favorite browser, 'http://127.0.0.1:8080/ejbca', and select the link for NOT having a browser'

Download the Root CA certificate by clicking on the link. Save the certificate as 'ca.pem'.

Enter the username and password of a valid user with status NEW, see question 'Why do I get the exception/error:' above. Copy and paste the contents of the certification request, 'myreq.p10' into the text field.
Save the returned certificate as 'cert.pem'.
</p>
<source>
# Import the Root CA certificate into the keystore 'myks.jks':
keytool -import -alias cacert -file ca.pem -keystore myks.jks -storepass foo123
# Import the certificate reply into the keystore:
keytool -import -alias mykey -file cert.pem -keystore myks.jks -storepass foo123 -keypass foo123
# Now you can take a look at your SUN keystore with:
keytool -list -keystore myks.jks
</source>
<p>
In theory, you can use the same method with a BouncyCastle PKCS12 keystore by adding the following
arguments to every command above:
</p>
<source>
-provider org.bouncycastle.jce.provider.BouncyCastleProvider/ -storetype PKCS12
</source>
<p>
unforturnately a bug in keytool prevents this from functioning properly at the moment, therefore I
recommend using the 'bin/ejbca.sh ca' to create PKCS12 keystores. It can be used to create keystores generally,
not just for CAs.
</p>	  
	  </answer>
	</faq>
	
  <faq id="exportClassification">
      <question>What is EJBCA's export classification in the United States of America?</question>
	  <answer>
	    <p>
	    At the time of writing (26 Feb 2008) EJBCA is approved classified under ECCN code 5D002 and approved for export under License Exception TSU. 
	    See The <a href="http://www.bis.doc.gov/licensing/exportingbasics.htm">Bureau of Industry and Security website</a> for further details.<br/>
	    EJBCA actually has the same classification as the Bouncy Castle JCE provider, from which this FAQ text is a rip-off. Thanks BC!
	    </p>
	  </answer>
  </faq>
  
  <faq id="passwordEE">
      <question>When a new end entity is created, where and how is the password stored?</question>
	  <answer>
	    <p>
		A one-time password is stored hashed with SHA-1 in the UserData table
		in the database. If the checkbox 'clear text password' is checked when
		adding the user the password is stored in clear text, to be used for
		server side generation.
	    </p>
	  </answer>
  </faq>
  
  <faq id="caKeyStorage">
      <question>Where are software based CA keys stored in the database?</question>
	  <answer>
	    <p>
		These keys are stored in a PKCS#12 file, encrypted with a password.
		The PKCS#12 is stored in the database in the CAData table. 
	    </p>
	  </answer>
  </faq>
  
  <faq id="keyRecoveryStorage">
      <question>If I enable key recovery, where are the end entities private keys stored in the database?</question>
	  <answer>
	    <p>
		The private keys for key recovery is stored in the KeyRecoveryData
		table in the database. The data is encrypted with the CAs encryption
		key. The private keys are only stored if key recovery is enabled. 
	    </p>
	  </answer>
  </faq>
  
  <faq id="glassfishFail1">
  <question>Galssfish issue no. 1: ant install fails with some weird errors.</question>
  <answer>
  <p>
  This issue affects Glassfishv2 Enterprise Edition (open source admin console is slightly different and doesn't have this features).
If you are experiencing errors when doing “ant install”, do the following:
<ul>
<li>Open up glassfish admin console in your browser (https://&lt;host-name>:4848/)</li>
<li>On the left hand side, expand Stand-Alone Instances node</li>
<li>Click on the server (Admin Server)</li>
<li>In the righ-hand broswer frame, click JNDI browsing button.</li>
<li>You should get Jndi tree browsing window.</li>
<li>Expand the jdbc node.</li>
<li>Make sure that jdbc/EjbcaDS exists.</li>
<li>If it exists, than this issue in not the cause for your “ant install” failure.</li>
<li>If it doesn't exist, do the following:</li>
<li>In the glassfish admin console, remove the EjbcaPool created earlier and remove data source jdbc/EjbcaDS.</li>
<li>Start EJBCA build from scratch with ant clean etc.</li>
</ul>
</p>
  </answer>  
  </faq>
  
  <faq id="GlassfishFail2">
  <question>Glassfish issue no. 2: ant install fails with some weird errors</question>
  <answer>
  <p>
This issue affects both Glassfishv2 Enterprise Edition and Glasfish v2 open source edition.
If you notice messages such as "database open for read only access", you have started glassfish with insufficient privileges. Stop the domain and restart it with privileges of the user who has full rights for glassfish.
  </p>
  </answer>
  </faq>
    
  </faqsection>

</document>
